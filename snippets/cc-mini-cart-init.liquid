<script>
  const prepareMiniCartInterface = function() {
      var mutationObserver = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
          if (mutation.addedNodes) {
            setTimeout(() => {
              const form = Array.from(mutation.addedNodes).find(x => x.tagName == 'FORM');
              if (form) {
                Aurigma.CcHelper.renderMiniCart();
                //console.log(mutation);
              }
            }, 500);
          }
        });
      });

      // Starts listening for changes in the '#CartContainer' HTML element
      mutationObserver.observe(document.querySelector('#CartContainer'), {
        childList: true,
        subtree: true
      });
  };
  document.addEventListener("DOMContentLoaded", function() {
    if (Aurigma.Storefront == undefined || Aurigma.Storefront.projectsBufferUrl == undefined) {
      const ecommerceSystem = {
        {%  if customer %}
        userId: ShopifyInit.getUserIdForCc('{{shop.domain}}', '{{ customer.id }}'),
		{%  else %}
		userId: ShopifyInit.getUserIdForCc('{{shop.domain}}'),
		{% endif %}                       
		pluginSettings: { currency: ShopifyInit.getCurrency() },
		tenantId: 1162
      };
      new CcHelper().loadProductForCc().then(ccProduct => {
        prepareMiniCartInterface();
        Aurigma.Storefront.loadIntegrationInfo(ecommerceSystem, ccProduct).then(result => {
          let tenantId = ecommerceSystem.tenantId.toString();
          let bufferUrl = Aurigma.Storefront.projectsBufferUrl + `/tenants/${tenantId}/projects/`;
          Aurigma.CcHelper = new CcHelper(tenantId, bufferUrl);
        });
      });     
  	} else {
        prepareMiniCartInterface();
  	}
  });
</script>